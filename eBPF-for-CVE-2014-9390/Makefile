# Compiler and tools
CLANG ?= clang
GCC ?= gcc
BPFTOOL ?= bpftool
LLVM_STRIP ?= llvm-strip # Added from the working example, though not used in this version yet

# Determine architecture for __TARGET_ARCH_xxx and kernel paths
ARCH := $(shell uname -m | sed 's/x86_64/x86/' | sed 's/aarch64/arm64/' | sed 's/riscv64/riscv/')

# Kernel headers location (base directory)
KERNEL_VERSION ?= $(shell uname -r)
# KERNEL_BASE_DIR is the directory containing 'include', 'arch', etc.
# e.g. /usr/src/linux-headers-5.15.0-116-generic
KERNEL_BASE_DIR ?= /usr/src/linux-headers-$(KERNEL_VERSION)
# KERNEL_HEADERS is the main include directory, e.g. /usr/src/linux-headers-xxx/include
KERNEL_HEADERS := $(KERNEL_BASE_DIR)/include

# --- Directories and Files ---
BPF_SRC := bpf_kern.c
USER_SRC := loader.c

BUILD_DIR := ./build
BPF_OUT_DIR := $(BUILD_DIR)/bpf
BPF_INTERNAL_INCLUDE_DIR := $(BPF_OUT_DIR)/internal# For vmlinux.h

# Output files
BPF_OBJ_NAME := $(notdir $(BPF_SRC:.c=.o)) # e.g., bpf_kern.o
BPF_OBJ := $(BPF_OUT_DIR)/$(BPF_OBJ_NAME)
BPF_SKELETON_NAME := $(notdir $(BPF_SRC:.c=.skel.h)) # e.g., bpf_kern.skel.h
BPF_SKELETON := $(BPF_OUT_DIR)/$(BPF_SKELETON_NAME)
USER_BIN := $(BUILD_DIR)/$(USER_SRC:.c=) # e.g., ./build/loader
VMLINUX_H := $(BPF_INTERNAL_INCLUDE_DIR)/vmlinux.h

# List of all directories to create
REQUIRED_DIRS := $(BPF_OUT_DIR) $(BPF_INTERNAL_INCLUDE_DIR) $(BUILD_DIR)

# --- Compiler Flags ---
# More granular kernel include paths
KERNEL_ARCH_INCLUDE_DIR := $(KERNEL_BASE_DIR)/arch/$(ARCH)/include
KERNEL_UAPI_INCLUDE_DIR := $(KERNEL_HEADERS)/uapi
KERNEL_GENERATED_INCLUDE_DIR := $(KERNEL_HEADERS)/generated
KERNEL_GENERATED_UAPI_INCLUDE_DIR := $(KERNEL_GENERATED_INCLUDE_DIR)/uapi # Often $(KERNEL_HEADERS)/generated/uapi
KERNEL_ARCH_UAPI_INCLUDE_DIR := $(KERNEL_ARCH_INCLUDE_DIR)/uapi
KERNEL_ARCH_GENERATED_INCLUDE_DIR := $(KERNEL_ARCH_INCLUDE_DIR)/generated
KERNEL_ARCH_GENERATED_UAPI_INCLUDE_DIR := $(KERNEL_ARCH_GENERATED_INCLUDE_DIR)/uapi

# BPF compiler flags (includes integrated)
BPF_CFLAGS := -g -O2 -target bpf \
              -D__TARGET_ARCH_$(ARCH) \
              -D__BPF_TRACING__ \
              -Wall -Werror \
              -I$(BPF_INTERNAL_INCLUDE_DIR) \
              -I/usr/include/bpf \
              -I$(KERNEL_HEADERS) \
              -I$(KERNEL_UAPI_INCLUDE_DIR) \
              -I$(KERNEL_GENERATED_INCLUDE_DIR) \
              -I$(KERNEL_GENERATED_UAPI_INCLUDE_DIR) \
              -I$(KERNEL_ARCH_INCLUDE_DIR) \
              -I$(KERNEL_ARCH_UAPI_INCLUDE_DIR) \
              -I$(KERNEL_ARCH_GENERATED_INCLUDE_DIR) \
              -I$(KERNEL_ARCH_GENERATED_UAPI_INCLUDE_DIR) \
              -I. # Include current directory

# User-space compiler flags
# $(BPF_OUT_DIR) for the generated skeleton header
USER_CFLAGS := -g -O2 -Wall -Werror -Wno-unknown-attributes -I$(BPF_OUT_DIR)
USER_LDFLAGS := -lbpf -lelf -lz

# --- Phony Targets ---
.PHONY: all clean directories

# --- Main Targets ---
all: directories $(USER_BIN)

# Rule to create all necessary directories
directories:
	@echo "Creating directories: $(REQUIRED_DIRS)"
	@mkdir -p $(REQUIRED_DIRS)

# Rule for the user-space binary
# Depends on the user source code and the generated BPF skeleton header
$(USER_BIN): $(USER_SRC) $(BPF_SKELETON)
	@echo "Compiling userspace loader: $(USER_SRC) -> $@"
	$(GCC) $(USER_CFLAGS) $(USER_SRC) -o $@ $(USER_LDFLAGS)

# Rule to generate BPF skeleton header from the BPF object file
$(BPF_SKELETON): $(BPF_OBJ)
	@echo "Generating BPF skeleton header: $@"
	$(BPFTOOL) gen skeleton $< > $@

# Rule for the BPF object file
# Depends on the BPF source code and vmlinux.h (for CO-RE)
$(BPF_OBJ): $(BPF_SRC) $(VMLINUX_H)
	@echo "Compiling BPF code: $(BPF_SRC) -> $@"
	$(CLANG) $(BPF_CFLAGS) -c $(BPF_SRC) -o $@

# Rule to generate vmlinux.h (for CO-RE)
$(VMLINUX_H): | directories
	@echo "Generating vmlinux.h for BPF CO-RE (requires /sys/kernel/btf/vmlinux)..."
	@echo "Target file for vmlinux.h is: $(VMLINUX_H)" # Add this for debugging
	@if [ ! -f /sys/kernel/btf/vmlinux ]; then \
		echo "Error: /sys/kernel/btf/vmlinux not found. BTF must be enabled in your kernel."; \
		echo "Try: sudo modprobe vmlinux_btf OR ensure CONFIG_DEBUG_INFO_BTF=y in kernel config."; \
		exit 1; \
	fi
	$(BPFTOOL) btf dump file /sys/kernel/btf/vmlinux format c > "$(VMLINUX_H)" # Use $(VMLINUX_H) directly and quote it

# --- Cleaning ---
clean:
	@echo "Cleaning up build artifacts..."
	rm -f $(USER_BIN) $(BPF_SKELETON)
	rm -rf $(BUILD_DIR) # This will remove BPF_OUT_DIR as well
	rm -f *~