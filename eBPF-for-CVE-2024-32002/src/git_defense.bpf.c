#include "vmlinux.h"
#include <bpf/bpf_helpers.h>
#include <bpf/bpf_core_read.h>
#include <bpf/bpf_tracing.h>

char LICENSE[] SEC("license") = "GPL";

#define MAX_PATH_LEN 256
#define TASK_COMM_LEN 16
#define EPERM 1
// ----------- PROBE: Log suspicious obfuscated ".GIT" open -----------
SEC("kprobe/vfs_open")
int BPF_KPROBE(kprobe_vfs_open, struct file *file) {
     bpf_printk("vfs_open triggered!\n");
    struct dentry *dentry = BPF_CORE_READ(file, f_path.dentry);
    const char *dname = BPF_CORE_READ(dentry, d_name.name);

    char fname[MAX_PATH_LEN];
    long ret = bpf_probe_read_kernel_str(&fname, sizeof(fname), dname);
    if (ret <= 0) return 0;

    // Basic case-insensitive match for ".GIT"
    if ((fname[0] == '.' || fname[0] == '.') &&
        (fname[1] == 'G' || fname[1] == 'g') &&
        (fname[2] == 'I' || fname[2] == 'i') &&
        (fname[3] == 'T' || fname[3] == 't') &&
        fname[4] == '\0') {
        bpf_printk("ðŸš¨ Suspicious open: obfuscated .GIT accessed: %s\n", fname);
    }

    return 0;
}

// ----------- LSM: Deny creation in .git/hooks/ by git -----------
SEC("lsm/inode_create")
int BPF_PROG(deny_git_hook_creation, struct inode *dir, struct dentry *dentry, umode_t mode) {
    char comm[TASK_COMM_LEN];
    bpf_get_current_comm(&comm, sizeof(comm));

    // Only apply to the git process
    if (!(comm[0] == 'g' && comm[1] == 'i' && comm[2] == 't' && comm[3] == '\0')) {
        return 0;
    }

    // Read current dir name (e.g., "hooks")
    char dirname[64];
    struct qstr dir_qstr = BPF_CORE_READ(dentry, d_parent, d_name);
    bpf_probe_read_kernel_str(&dirname, sizeof(dirname), dir_qstr.name);

    // Read grandparent dir name (e.g., ".git")
    char parentname[64];
    struct dentry *gp = BPF_CORE_READ(dentry, d_parent, d_parent);
    if (gp) {
        struct qstr gp_qstr = BPF_CORE_READ(gp, d_name);
        bpf_probe_read_kernel_str(&parentname, sizeof(parentname), gp_qstr.name);
    } else {
        parentname[0] = '\0';
    }

    // Check for ".git/hooks" (case insensitive)
    bool is_hooks = (dirname[0] == 'h' || dirname[0] == 'H') &&
                    dirname[1] == 'o' && dirname[2] == 'o' &&
                    dirname[3] == 'k' && dirname[4] == 's';

    bool is_dotgit = (parentname[0] == '.' &&
                     (parentname[1] == 'g' || parentname[1] == 'G') &&
                     (parentname[2] == 'i' || parentname[2] == 'I') &&
                     (parentname[3] == 't' || parentname[3] == 'T') &&
                     parentname[4] == '\0');

    if (is_hooks && is_dotgit) {
        bpf_printk("Blocked git from creating file in .git/hooks/\n");
        return -EPERM;
    }

    return 0;
}

