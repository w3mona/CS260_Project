#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <bpf/libbpf.h>

int main() {
    struct bpf_object *obj;
    struct bpf_program *prog;
    struct bpf_link *link;
    int err;

    // Open compiled eBPF object
    obj = bpf_object__open_file("git_defense.bpf.o", NULL);
    if (libbpf_get_error(obj)) {
        fprintf(stderr, "Failed to open BPF object file\n");
        return 1;
    }

    // Load eBPF programs into the kernel
    err = bpf_object__load(obj);
    if (err) {
        fprintf(stderr, " Failed to load BPF object: %d\n", err);
        return 1;
    }

    // Attach all programs inside the object
    bpf_object__for_each_program(prog, obj) {
        link = bpf_program__attach(prog);
        if (libbpf_get_error(link)) {
            fprintf(stderr, " Failed to attach program: %s\n", bpf_program__name(prog));
            return 1;
        } else {
            printf("Attached: %s\n", bpf_program__name(prog));
        }
    }

    printf(" All BPF programs loaded and attached. Running...\n");

    while (1) {
        sleep(1);
    }

    return 0;
}

